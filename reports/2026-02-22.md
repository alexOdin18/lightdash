# Отчёт за 22.02.2026

## Что сделано

### 1. Семантический слой в Jaffle Shop (DuckDB)
- В `jaffle_shop_duckdb/models/schema.yml` добавлен семантический слой Lightdash: метрики, измерения, связи между моделями `customers` и `orders`.
- Метрики: Total orders, Completed orders, Total revenue, Average order value, Fulfillment rate, Unique customers, Total customer value и др.
- Добавлен `lightdash.config.yml` с категориями Spotlight.
- В модель `orders` добавлена колонка `is_completed` для фильтрации выполненных заказов.

### 2. Подключение к PostgreSQL и перенос данных
- Создан `.env` в корне `lightdash` с переменными: `WAREHOUSE_PGHOST`, `WAREHOUSE_PGPORT`, `WAREHOUSE_PGDATABASE`, `WAREHOUSE_PGUSER`, `WAREHOUSE_PGPASSWORD`, `WAREHOUSE_PGSCHEMA`, `DB_SSL_MODE`, `DB_SSL_ROOT_CERT`, а также переменные для Lightdash (PGHOST, PGPASSWORD, LIGHTDASH_SECRET, DBT_PROJECT_DIR и т.д.).
- В `jaffle_shop_duckdb/profiles.yml` добавлен профиль **postgres** с поддержкой SSL (`sslmode`, `sslrootcert` из env).
- Для обхода ошибки «self-signed certificate in certificate chain» режим SSL изменён на **`require`** (шифрование без проверки сертификата).
- Выполнены: `dbt seed --target postgres`, `dbt run --target postgres`, `dbt test --target postgres` — данные и модели развёрнуты в облачной PostgreSQL (схема `jaffle_shop`).

### 3. Запуск Lightdash (Docker Compose)
- Исправлена ошибка «password authentication failed for user postgres»: пересоздан volume БД (`docker compose down -v` + `up -d`), в `.env` задан непустой `PGPASSWORD`.
- В `.env` задан `DBT_PROJECT_DIR` (путь к `jaffle_shop_duckdb`) для монтирования dbt-проекта в контейнер.
- Добавлена инструкция в `LIGHTDASH_ПРОВЕРКА.md`: что делает команда `docker compose --env-file ..\.env up -d`, типичные ошибки и их решение.

### 4. Подключение проекта в Lightdash
- В UI: dbt local server, target **postgres**, schema **jaffle_shop**.
- В переменных окружения dbt в Lightdash заданы: `WAREHOUSE_*`, `DB_SSL_MODE=require` (и при необходимости остальные из `.env`).

### 5. MinIO и ошибка «getaddrinfo ENOTFOUND minio»
- Lightdash использует MinIO (S3) для кэша результатов запросов и выгрузок; без работающего MinIO запросы падают.
- Создан **`lightdash-official/docker-compose.override.yml`**: образ MinIO заменён на официальный `minio/minio`, переопределены **entrypoint** (`/usr/bin/docker-entrypoint.sh`) и **command**, чтобы перекрыть базовый `init-minio.sh` из compose.
- Задан **container_name: minio**, чтобы хостнейм `minio` резолвился из контейнера Lightdash.
- Бакет **default** создан вручную: `docker run --rm --network lightdash-official_default minio/mc ... mb myminio/default`.

---

## Ограничения и нюансы (сохранить)

1. **SSL к облачной PostgreSQL**  
   Используется режим **`require`**, а не `verify-full`, из‑за self-signed/корпоративного сертификата. Соединение шифруется, но сертификат сервера не проверяется.

2. **Lightdash не поддерживает DuckDB** как warehouse. Запросы к данным идут только в Postgres (или другой поддерживаемый warehouse). Проект `jaffle_shop_duckdb` можно собирать локально на DuckDB, но для работы в Lightdash нужен target **postgres** и данные в PostgreSQL.

3. **MinIO обязателен** для выполнения запросов в Lightdash (кэш результатов в S3). В override должен быть рабочий образ MinIO и бакет **default**. После пересоздания контейнеров бакет при необходимости создавать заново (вручную в Console http://localhost:9001 или через `mc mb`).

4. **Команда запуска** — из каталога **lightdash-official**:  
   `docker compose --env-file ..\.env up -d`  
   Путь `..\.env` — к `.env` в каталоге `lightdash`. Без `--env-file` переменные (PGPASSWORD, DBT_PROJECT_DIR и т.д.) не подхватятся.

5. **Пароль БД Lightdash (сервис db)** задаётся при первой инициализации volume. Смена `PGPASSWORD` в `.env` без пересоздания volume (`down -v` + `up -d`) не меняет пароль уже созданной БД.

6. **Пути в .env** на Windows лучше задавать с прямыми слэшами (например, `C:/Users/.../root.crt`) во избежание экранирования в shell.

7. **`.env` в .gitignore** — не коммитить файл с паролями и секретами.
