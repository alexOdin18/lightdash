# ============================================================
# СЕМАНТИЧЕСКИЙ СЛОЙ — КАТАЛОГ КЛЮЧЕВЫХ МЕТРИК КОМПАНИИ
# ============================================================
# Здесь определены бизнес-метрики, единые для всей компании.
# Метрики автоматически появляются в Lightdash для анализа.
# ============================================================

version: 2
models:
  - name: company_kpis
    description: |
      # Каталог ключевых метрик компании
      
      Семантический слой — единый источник правды для бизнес-метрик.
      Все метрики определены здесь и доступны в Lightdash для отчётов и дашбордов.
    config:
      meta:
        primary_key: order_id
        joins:
          - join: customers
            sql_on: ${customers.customer_id} = ${company_kpis.customer_id}
            relationship: many-to-one
            label: Заказчик
        default_time_dimension:
          field: order_date
          interval: MONTH
    columns:
      - name: order_id
        description: Уникальный идентификатор заказа
        config:
          meta:
            metrics:
              # --- МЕТРИКИ ПО ЗАКАЗАМ ---
              total_orders:
                type: count_distinct
                label: Всего заказов
                description: Общее количество заказов (KPI)
              completed_orders:
                type: count_distinct
                label: Выполненных заказов
                description: Количество завершённых заказов
                filters:
                  - is_completed: "true"
        meta:
          dimension:
            type: number

      - name: order_date
        description: Дата заказа
        config:
          meta:
            dimension:
              type: date
              time_intervals: ["DAY", "WEEK", "MONTH", "YEAR", "QUARTER_NAME"]
        meta:
          dimension:
            type: date

      - name: status
        description: Статус заказа
        meta:
          dimension:
            type: string

      - name: amount
        description: Сумма заказа (USD)
        config:
          meta:
            metrics:
              # --- ФИНАНСОВЫЕ МЕТРИКИ ---
              total_revenue:
                type: sum
                format: usd
                round: 2
                label: Выручка (всего)
                description: Общая выручка — ключевая метрика компании
              completed_revenue:
                type: sum
                format: usd
                round: 2
                label: Выручка (выполненные)
                description: Выручка только от выполненных заказов
                filters:
                  - is_completed: "true"
              average_order_value:
                type: average
                format: usd
                round: 2
                label: Средний чек
                description: Средняя сумма заказа
        meta:
          dimension:
            type: number

      - name: customer_id
        description: ID клиента
        config:
          meta:
            metrics:
              # --- МЕТРИКИ ПО КЛИЕНТАМ ---
              unique_customers:
                type: count_distinct
                label: Уникальных клиентов
                description: Количество уникальных покупателей
        meta:
          dimension:
            type: number

      - name: is_completed
        description: Заказ выполнен
        config:
          meta:
            metrics:
              fulfillment_rate:
                type: average
                format: percent
                round: 1
                sql: CASE WHEN ${is_completed} THEN 1 ELSE 0 END
                label: "Fulfillment rate (%)"
                description: "Share of completed orders"
        meta:
          dimension:
            type: boolean
